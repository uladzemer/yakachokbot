name: yakachokbot

services:
  telegram-bot:
    build: .
    restart: unless-stopped
    volumes:
      - ./yakachokbot:/app/storage
      - telegram-bot-server-data:/var/lib/telegram-bot-api
    env_file:
      - .env
    environment:
      # get your bot token from @BotFather
      TELEGRAM_BOT_TOKEN: "${TELEGRAM_BOT_TOKEN}"

      # comma separated list of telegram user ids, leave empty to allow all users
      WHITELISTED_IDS: "${WHITELISTED_IDS}"

      # admin user id
      ADMIN_ID: "${ADMIN_ID}"

      # whether to allow groups (optional, defaults to "false")
      ALLOW_GROUPS: "false"

      TELEGRAM_API_ROOT: "http://telegram-bot-api:8081"

      # whether to automatically update yt-dlp
      # defaults to "true", set to "false" to disable
      YTDL_AUTOUPDATE: "true"
      # optional proxy for yt-dlp (e.g. socks5://user:pass@host:port)
      YTDL_PROXY: "${YTDL_PROXY}"

      # provide your OpenAI API key to enable auto-translation (optional)
      OPENAI_API_KEY: "${OPENAI_API_KEY}"

      # provide your cobalt instance url (optional, can be left as-is for the default compose.yml)
      COBALT_INSTANCE_URL: "http://cobalt:9000"
      STORAGE_DIR: "/app/storage"

    depends_on:
      telegram-bot-api:
        condition: service_healthy
      cobalt:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f \"tsx -r dotenv/config src/index.ts\" >/dev/null || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 3
    mem_limit: 2g
    cpus: "1.0"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  admin-panel:
    build: .
    restart: unless-stopped
    volumes:
      - ./yakachokbot:/app/storage
    env_file:
      - .env
    environment:
      ADMIN_ONLY: "true"
      ADMIN_DASHBOARD_HOST: "0.0.0.0"
      ADMIN_DASHBOARD_PORT: "${ADMIN_DASHBOARD_PORT:-3012}"
      ADMIN_DASHBOARD_USER: "${ADMIN_DASHBOARD_USER}"
      ADMIN_DASHBOARD_PASSWORD: "${ADMIN_DASHBOARD_PASSWORD}"
      STORAGE_DIR: "/app/storage"
    ports:
      - "${ADMIN_DASHBOARD_PORT:-3012}:${ADMIN_DASHBOARD_PORT:-3012}"
    depends_on:
      telegram-bot-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:${ADMIN_DASHBOARD_PORT:-3012}/admin >/dev/null || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 3
    mem_limit: 512m
    cpus: "0.5"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  telegram-bot-api:
    image: aiogram/telegram-bot-api:latest
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # get these values from https://core.telegram.org/api/obtaining_api_id
      TELEGRAM_API_ID: "${TELEGRAM_API_ID}"
      TELEGRAM_API_HASH: "${TELEGRAM_API_HASH}"
    command:
      - --dir=/var/lib/telegram-bot-api
      - --local
    volumes:
      - telegram-bot-server-data:/var/lib/telegram-bot-api
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 8081 || exit 1"]
      interval: 5s
      timeout: 30s
      retries: 3
    mem_limit: 1g
    cpus: "1.0"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  cobalt:
    image: ghcr.io/imputnet/cobalt:latest
    restart: unless-stopped
    environment:
      - API_URL=http://cobalt:9000
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9000"]
      interval: 5s
      timeout: 30s
      retries: 3
    mem_limit: 1g
    cpus: "1.0"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  watchtower:
    image: containrrr/watchtower
    restart: unless-stopped
    environment:
      - DOCKER_API_VERSION=1.44
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 3600 --cleanup
    mem_limit: 512m
    cpus: "0.5"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  telegram-bot-server-data:
    driver: local
